<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NxLife Community Connect</title>
    
    <!-- External Libraries -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-dark: #6F4E37; /* Coffee Bean */
            --primary-light: #A67B5B; /* Latte */
            --cream: #F5F5DC; /* Cream */
            --bg-gradient: linear-gradient(135deg, #2C2019 0%, #6F4E37 100%);
            --text-color: #333;
            --white: #ffffff;
        }

        body {
            font-family: 'Prompt', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
        }

        .container {
            width: 90%;
            max-width: 400px;
            background: var(--cream);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Loading State */
        #loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--primary-light);
            border-top: 5px solid var(--primary-dark);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Form Elements */
        .hidden { display: none !important; }

        .profile-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: -20px;
        }
        .profile-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--white);
            object-fit: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        h2 { color: var(--primary-dark); margin-bottom: 0.5rem; font-size: 1.2rem; }
        .greeting { color: #888; font-style: italic; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .label-text { font-size: 1rem; color: var(--primary-dark); margin-bottom: 1rem; display: block; }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Prompt', sans-serif;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus {
            border-color: var(--primary-light);
        }

        .btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(to right, var(--primary-light), var(--primary-dark));
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(111, 78, 55, 0.3);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }

        /* Zoom Button (Case 1 & iOS Fallback) */
        .zoom-container {
            text-align: center;
        }
        .zoom-btn {
            background: #2D8CFF; /* Zoom Blue */
            font-size: 1.2rem;
        }
        .zoom-icon { font-size: 2rem; display: block; margin-bottom: 5px; }

        .status-msg { margin-top: 10px; font-size: 0.9rem; color: #666; }
    </style>
</head>
<body>

    <div class="container" id="app-container">
        
        <!-- LOADING SCREEN -->
        <div id="loading">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <!-- FORM SCREEN (Case 2) -->
        <div id="form-screen" class="hidden">
            <div class="profile-section">
                <img id="user-profile-img" src="" alt="Profile" class="profile-img">
            </div>
            <div style="clear: both; height: 10px;"></div>
            
            <p class="greeting" id="greeting-msg">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏Ñ‡∏∏‡∏ì ...</p>
            <label class="label-text">‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö?</label>
            
            <input type="text" id="input-realname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ)">
            <input type="text" id="input-nickname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏µ‡πã A1)">
            
            <button class="btn" id="btn-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ Zoom</button>
        </div>

        <!-- ZOOM LINK SCREEN (Fallback / Success) -->
        <div id="zoom-screen" class="hidden zoom-container">
            <h2>‡πÄ‡∏õ‡∏¥‡∏î Zoom Meeting</h2>
            <p class="status-msg">‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
            <button class="btn zoom-btn" id="btn-open-zoom">
                <span class="zoom-icon">üé•</span>
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á Zoom ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ
            </button>
        </div>

        <!-- ERROR SCREEN -->
        <div id="error-screen" class="hidden">
            <h2 style="color: #d9534f;">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢</h2>
            <p id="error-msg">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
        </div>

    </div>

    <script>
        // ***************** CONFIGURATION *****************
        // ‡∏ô‡∏≥ URL Web App ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwEPR9FARhVxyQu3_spLb47kue08an21zNlrpOb5Xg7-hr_4Ag3U726Wl-ICUTWY_F3nQ/exec"; 
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
        let liffId = ""; // LIFF ID ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ liff.line.me ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ Endpoint ‡∏ï‡∏£‡∏á‡πÜ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà
        let params = {};
        let lineProfile = {};

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        async function main() {
            try {
                // 1. Initialize LIFF
                await liff.init({ liffId: "2008560135-06VyMziu" }); // ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 2. Parse Parameters
                // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å liff.state ‡∏´‡∏£‡∏∑‡∏≠ window.location.search
                const urlParams = new URLSearchParams(window.location.search);
                params = {
                    Zopen: urlParams.get('Zopen'),
                    Zid: urlParams.get('Zid'),
                    Zpass: urlParams.get('Zpass'),
                    Activity: urlParams.get('Activity'),
                    Sdate: urlParams.get('Sdate'),
                    Edate: urlParams.get('Edate')
                };

                // 3. Logic ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
                if (params.Zopen !== '1') {
                    showError("Parameter ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Zopen != 1)");
                    return;
                }

                if (!checkTime(params.Sdate, params.Edate)) {
                    showError("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
                    return;
                }

                // 4. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
                lineProfile = await liff.getProfile();
                
                // 5. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                const checkResponse = await callGAS('checkUser', { userId: lineProfile.userId });

                if (checkResponse.userExists && checkResponse.hasRegisterName) {
                    // Case 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö -> ‡πÄ‡∏õ‡∏¥‡∏î Zoom ‡πÄ‡∏•‡∏¢ + Log CheckIN Background
                    openZoomAndLog();
                } else {
                    // Case 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö -> ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                    showForm();
                }

            } catch (err) {
                console.error(err);
                showError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + err.message);
            }
        }

        // --- Logic Functions ---

        function checkTime(sDateStr, eDateStr) {
            if (!sDateStr || !eDateStr) return true; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡∏Å‡∏≥‡∏Å‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (Assumption)
            
            // Format ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ISO 
            // Assumption: Parameter ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô String ‡∏ó‡∏µ‡πà Date.parse ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ 
            // ‡∏´‡∏≤‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD HH:mm ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Timezone
            
            const now = new Date();
            const start = new Date(sDateStr);
            const end = new Date(eDateStr);

            // ‡∏Å‡∏£‡∏ì‡∏µ Date Invalid ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞ Block ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏° Requirement
            if (isNaN(start.getTime()) || isNaN(end.getTime())) return true;

            return now >= start && now <= end;
        }

        function showForm() {
            hideAll();
            document.getElementById('form-screen').classList.remove('hidden');
            
            // Set User Info
            document.getElementById('user-profile-img').src = lineProfile.pictureUrl || "https://via.placeholder.com/50";
            document.getElementById('greeting-msg').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏Ñ‡∏∏‡∏ì ${lineProfile.displayName}`;
            
            // Bind Event
            document.getElementById('btn-confirm').onclick = handleFormSubmit;
        }

        async function handleFormSubmit() {
            const realName = document.getElementById('input-realname').value.trim();
            const nickName = document.getElementById('input-nickname').value.trim();

            if (!realName && !nickName) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö?',
                    confirmButtonColor: '#6F4E37'
                });
                return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á Loading ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°
            const btn = document.getElementById('btn-confirm');
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            btn.disabled = true;

            // ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ Zoom ‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
            openZoom();

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Background
            callGAS('registerAndLog', {
                userId: lineProfile.userId,
                displayName: lineProfile.displayName,
                pictureUrl: lineProfile.pictureUrl,
                statusMessage: lineProfile.statusMessage,
                realName: realName,
                nickName: nickName,
                activity: params.Activity
            }); // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á await ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        }

        function openZoomAndLog() {
            // ‡∏¢‡∏¥‡∏á Zoom ‡πÄ‡∏•‡∏¢
            openZoom();
            
            // Log CheckIN Background
            callGAS('logCheckIn', {
                userId: lineProfile.userId,
                activity: params.Activity
            });
        }

        function openZoom() {
            hideAll();
            document.getElementById('zoom-screen').classList.remove('hidden');
            
            const zoomUrl = `https://zoom.us/j/${params.Zid}?pwd=${params.Zpass}`;
            
            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            liff.openWindow({
                url: zoomUrl,
                external: true
            });

            // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á (iOS)
            document.getElementById('btn-open-zoom').onclick = function() {
                liff.openWindow({
                    url: zoomUrl,
                    external: true
                });
            };
        }

        // --- Helper Functions ---

        async function callGAS(action, payload) {
            const body = JSON.stringify({ action: action, ...payload });
            
            // ‡πÉ‡∏ä‡πâ fetch mode: 'no-cors' ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ response 
            // ‡πÅ‡∏ï‡πà GAS ‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô return JSON ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                body: body,
                // headers: { "Content-Type": "text/plain;charset=utf-8" } // GAS ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡∏ä‡∏≠‡∏ö text/plain
            });
            
            return await response.json();
        }

        function hideAll() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('form-screen').classList.add('hidden');
            document.getElementById('zoom-screen').classList.add('hidden');
            document.getElementById('error-screen').classList.add('hidden');
        }

        function showError(msg) {
            hideAll();
            document.getElementById('error-screen').classList.remove('hidden');
            document.getElementById('error-msg').innerText = msg;
        }

        // Run
        main();

    </script>
</body>
</html>
